<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
        }
        #login-signup, #main-menu {
            display: none;
            text-align: center;
            margin-top: 50px;
        }
        #login-signup.active, #main-menu.active {
            display: block;
        }
        #threejs-container {
            width: 100%;
            height: 400px;
            background-color: #000;
        }
        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
        }
        .user-actions {
            display: flex;
            gap: 10px;
        }
        #logged-in-user {
            margin-top: 20px;
            font-weight: bold;
        }
        #search-user-form {
            margin-top: 20px;
        }
        #search-results {
            margin-top: 0; /* Remove margin-top */
            position: absolute;
            width: 100%; /* Match width to input field */
            background-color: white;
            border: 1px solid #ccc;
            z-index: 1000;
            right: 0; /* Align to the right */
        }
        #friend-requests {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #search-user-form {
            margin-left: 20px;
            position: relative;
        }
        #search-results {
            margin-top: 0;
        }
        #search-results ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #search-results li {
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="login-signup" class="active">
        <h2>Login or Signup</h2>
        <form id="signin-form">
            <h3>Sign In</h3>
            <input type="email" id="signin-email" placeholder="Email" required>
            <input type="password" id="signin-password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
        <form id="signup-form">
            <h3>Sign Up</h3>
            <input type="email" id="signup-email" placeholder="Email" required>
            <input type="password" id="signup-password" placeholder="Password" required>
            <input type="password" id="signup-password2" placeholder="Confirm Password" required>
            <input type="text" id="signup-username" placeholder="Username" required>
            <button type="submit">Signup</button>
        </form>
        <button id="oauth-button">Login with 42</button>
    </div>
    <div id="main-menu">
        <div id="logged-in-user"></div>
        <h2>Main Menu</h2>
        <button onclick="searchGame()">Search and Launch Game</button>
        <button onclick="viewProfile()">View Profile</button>
        <button id="logout-button">Logout</button>
        <ul id="user-list"></ul>
        <div id="friend-requests">
            <h3>Friend Requests</h3>
            <form id="search-user-form" style="position: relative;">
                <input type="text" id="search-username" placeholder="Search Username" required style="width: 100%;">
                <div id="search-results"></div> <!-- Move inside form to ensure same width and position -->
            </form>
        </div>
        <ul id="friend-request-list"></ul>
        <div id="threejs-container"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let globalSocket = null;

        document.getElementById('signin-form').addEventListener('submit', async function (event) {
            event.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            try {
                const response = await fetch('http://127.0.0.1:8000/api/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (data.access) {
                    const accessToken = data.access;
                    const username = data.user.username;
                    const userId = data.user.id;
                    sessionStorage.setItem('accessToken', accessToken);
                    sessionStorage.setItem('username', username);
                    sessionStorage.setItem('userId', userId);
                    connectWebSocket(accessToken, username, userId);
                    showMainMenu();
                    fetchConnectedUsers(accessToken);
                } else {
                    alert('Login failed. Please check your credentials.');
                }
            } catch (error) {
                console.error('Error during login or WebSocket connection:', error);
                alert('Login failed. Please try again.');
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async function (event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const password2 = document.getElementById('signup-password2').value;
            const username = document.getElementById('signup-username').value;
            try {
                const response = await fetch('http://127.0.0.1:8000/api/auth/signup/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, password2, username })
                });
                const data = await response.json();
                if (data.access) {
                    const accessToken = data.access;
                    const username = data.user.username;
                    const userId = data.user.id;
                    sessionStorage.setItem('accessToken', accessToken);
                    sessionStorage.setItem('username', username);
                    sessionStorage.setItem('userId', userId);
                    connectWebSocket(accessToken, username, userId);
                    showMainMenu();
                } else {
                    alert('Signup failed. Please check your details.');
                }
            } catch (error) {
                console.error('Error during signup or WebSocket connection:', error);
                alert('Signup failed. Please try again.');
            }
        });

        document.getElementById('oauth-button').addEventListener('click', function () {
            const oauthUrl = 'https://api.intra.42.fr/oauth/authorize?client_id=u-s4t2ud-6d896cbba0cf9cbd760394daeca2728498dace7f3254b04ac08fe1fc0dcc73f3&redirect_uri=http%3A%2F%2F127.0.0.1%3A3000%2FzTestTools%2Fsucces.html&response_type=code';
            const popup = window.open(oauthUrl, 'OAuth Login', 'width=600,height=600');
            const interval = setInterval(function () {
                try {
                    if (popup.location.href.indexOf('code=') !== -1) {
                        const urlParams = new URLSearchParams(popup.location.search);
                        const code = urlParams.get('code');
                        if (code) {
                            fetch(`http://127.0.0.1:8000/api/auth/oauth/?code=${code}`, {
                                method: 'GET'
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.access) {
                                    sessionStorage.setItem('accessToken', data.access);
                                    sessionStorage.setItem('refreshToken', data.refresh);
                                    sessionStorage.setItem('userId', data.user.id);
                                    sessionStorage.setItem('username', data.user.username);
                                    showMainMenu();
                                } else {
                                    alert('OAuth failed');
                                }
                            })
                            .catch(error => {
                                console.error('Error during OAuth request:', error);
                            });
                            popup.close();
                            clearInterval(interval);
                        }
                    }
                } catch (error) {
                    console.error('Error checking popup URL:', error);
                }
            }, 1000);
        });

        window.addEventListener('load', function () {
            const accessToken = sessionStorage.getItem('accessToken');
            const username = sessionStorage.getItem('username');
            const userId = sessionStorage.getItem('userId');
            if (accessToken && username && userId) {
                connectWebSocket(accessToken, username, userId);
                showMainMenu();
            } else {
                document.getElementById('login-signup').classList.add('active');
            }
        });

        document.getElementById('logout-button').addEventListener('click', function () {
            if (globalSocket) {
                globalSocket.close();
            }
            sessionStorage.removeItem('accessToken');
            sessionStorage.removeItem('username');
            sessionStorage.removeItem('userId');
            location.reload();
        });

        function connectWebSocket(accessToken, username, userId) {
            const userList = document.getElementById('user-list');
            const friendRequestList = document.getElementById('friend-request-list');
            const socket = new WebSocket(`ws://localhost:8005/ws/lobby/`, [`Bearer_${accessToken}`]);
            globalSocket = socket;

            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                console.log('Received WebSocket message:', data);

                switch(data.type) {
                    case 'list_user_connected':
                        handleUserList(data, userList, userId, socket);
                        break;
                    case 'invite_code':
                        displayInviteCode(data);
                        break;
                    case 'friend_request':
                        handleFriendRequest(data, friendRequestList);
                        break;
                    default:
                        console.log('Unhandled message type:', data.type);
                }
            };

            socket.onopen = function () {
                console.log('WebSocket connection established');
            };

            socket.onclose = function () {
                console.log('WebSocket connection closed');
            };

            socket.onerror = function (error) {
                console.error('WebSocket error:', error);
            };
        }

        function handleUserList(data, userList, currentUserId, socket) {
            userList.innerHTML = '';
            data.users
                .filter(user => user.id !== currentUserId)
                .forEach(user => {
                    const li = document.createElement('li');
                    li.classList.add('user-item');

                    const userInfo = document.createElement('span');
                    userInfo.textContent = `${user.username} (ID: ${user.id})`;

                    const userActions = document.createElement('div');
                    userActions.classList.add('user-actions');

                    const inviteButton = document.createElement('button');
                    inviteButton.textContent = 'Invite';
                    inviteButton.onclick = function () {
                        sendInvite(user.id, socket);
                    };

                    const friendRequestButton = document.createElement('button');
                    friendRequestButton.textContent = 'Send Friend Request';
                    friendRequestButton.onclick = function () {
                        sendFriendRequest(user.id);
                    };

                    userActions.appendChild(inviteButton);
                    userActions.appendChild(friendRequestButton);

                    li.appendChild(userInfo);
                    li.appendChild(userActions);
                    userList.appendChild(li);
                });
        }

        function sendInvite(inviteeId, socket) {
            socket.send(JSON.stringify({
                invitee_id: inviteeId
            }));
        }

        function sendFriendRequest(receiverId) {
            if (!globalSocket) {
                console.error('WebSocket not connected');
                return;
            }

            fetch('http://127.0.0.1:8004/user/friends/request/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionStorage.getItem('accessToken')}`
                },
                body: JSON.stringify({
                    friend_id: receiverId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Friend request sent:', data);
                alert('Friend request sent successfully!');
            })
            .catch(error => {
                console.error('Error sending friend request:', error);
                alert('Failed to send friend request');
            });
        }

        function handleFriendRequest(data, friendRequestList) {
            const requestItem = document.createElement('li');
            requestItem.classList.add('friend-request');
            
            const requestText = document.createElement('span');
            requestText.textContent = `Friend request from User ID: ${data.sender_id}`;
            
            const acceptButton = document.createElement('button');
            acceptButton.textContent = 'Accept';
            acceptButton.onclick = () => {
                updateFriendRequest(data.sender_id, 'accepted');
                requestItem.remove();
            };
            
            const rejectButton = document.createElement('button');
            rejectButton.textContent = 'Reject';
            rejectButton.onclick = () => {
                updateFriendRequest(data.sender_id, 'refused');
                requestItem.remove();
            };
            
            requestItem.appendChild(requestText);
            requestItem.appendChild(acceptButton);
            requestItem.appendChild(rejectButton);
            
            friendRequestList.appendChild(requestItem);
            fetchFriendRequests(); // Fetch and display friend requests
        }

        function fetchFriendRequests() {
            const accessToken = sessionStorage.getItem('accessToken');
            fetch('http://127.0.0.1:8004/user/friends/listrequests/', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const friendRequestList = document.getElementById('friend-request-list');
                friendRequestList.innerHTML = '';
                data.pending_requests.forEach(request => {
                    const requestItem = document.createElement('li');
                    requestItem.classList.add('friend-request');
                    
                    const requestText = document.createElement('span');
                    requestText.textContent = `Friend request from User ID: ${request}`;
                    
                    const acceptButton = document.createElement('button');
                    acceptButton.textContent = 'Accept';
                    acceptButton.onclick = () => {
                        updateFriendRequest(request, 'accepted');
                        requestItem.remove();
                    };
                    
                    const rejectButton = document.createElement('button');
                    rejectButton.textContent = 'Reject';
                    rejectButton.onclick = () => {
                        updateFriendRequest(request, 'refused');
                        requestItem.remove();
                    };
                    
                    requestItem.appendChild(requestText);
                    requestItem.appendChild(acceptButton);
                    requestItem.appendChild(rejectButton);
                    
                    friendRequestList.appendChild(requestItem);
                });
            })
            .catch(error => console.error('Error fetching friend requests:', error));
        }

        function updateFriendRequest(friendId, status) {
            const accessToken = sessionStorage.getItem('accessToken');
            fetch('http://127.0.0.1:8004/user/friends/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    friend_id: friendId,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(`Friend request ${status}:`, data);
                alert(`Friend request ${status} successfully!`);
            })
            .catch(error => {
                console.error(`Error updating friend request to ${status}:`, error);
                alert(`Failed to ${status} friend request`);
            });
        }

        function displayInviteCode(data) {
            console.log('Invite code received:', data);
            alert(`Invite Code: ${data.invite_code}`);
        }

        function showMainMenu() {
            document.getElementById('login-signup').classList.remove('active');
            document.getElementById('main-menu').classList.add('active');
            document.getElementById('logged-in-user').textContent = `Logged in as: ${sessionStorage.getItem('username')}`;
            initThreeJS();
            fetchFriendList(); // Fetch and display the friend list
            fetchFriendRequests(); // Fetch and display the friend requests
        }

        function fetchFriendList() {
            const accessToken = sessionStorage.getItem('accessToken');
            fetch('http://127.0.0.1:8004/user/friends/', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const friendIds = data.friends;
                if (friendIds.length > 0) {
                    fetch('http://127.0.0.1:8000/api/auth/users/info/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ user_ids: friendIds })
                    })
                    .then(response => response.json())
                    .then(userData => {
                        const friendList = document.getElementById('friend-request-list');
                        friendList.innerHTML = '';
                        friendIds.forEach(friendId => {
                            const li = document.createElement('li');
                            li.textContent = `Friend: ${userData[friendId].username} (ID: ${friendId})`;

                            const removeButton = document.createElement('button');
                            removeButton.textContent = 'Remove Friend';
                            removeButton.onclick = () => {
                                updateFriendRequest(friendId, 'refused');
                                li.remove();
                            };

                            li.appendChild(removeButton);
                            friendList.appendChild(li);
                        });
                    })
                    .catch(error => console.error('Error fetching friend details:', error));
                }
            })
            .catch(error => console.error('Error fetching friend list:', error));
        }

        function searchGame() {
            const accessToken = sessionStorage.getItem('accessToken');
            fetch('http://127.0.0.1:8002/api/search-game/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Game search result:', data);
            })
            .catch(error => console.error('Error searching game:', error));
        }

        function viewProfile() {
            const accessToken = sessionStorage.getItem('accessToken');
            fetch('http://127.0.0.1:8000/api/user/profile/', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Profile:', data);
            })
            .catch(error => console.error('Error viewing profile:', error));
        }

        function initThreeJS() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('threejs-container').appendChild(renderer.domElement);

            const geometry = new THREE.BoxGeometry();
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            camera.position.z = 5;

            function animate() {
                requestAnimationFrame(animate);
                cube.rotation.x += 0.01;
                cube.rotation.y += 0.01;
                renderer.render(scene, camera);
            }
            animate();
        }

        function fetchConnectedUsers(accessToken) {
            fetch('http://127.0.0.1:8000/api/user/connected/', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const userList = document.getElementById('user-list');
                userList.innerHTML = '';
                data.users.forEach(user => {
                    const li = document.createElement('li');
                    li.classList.add('user-item');

                    const userInfo = document.createElement('span');
                    userInfo.textContent = `${user.username} (ID: ${user.id})`;

                    const userActions = document.createElement('div');
                    userActions.classList.add('user-actions');

                    const inviteButton = document.createElement('button');
                    inviteButton.textContent = 'Invite';
                    inviteButton.onclick = function () {
                        sendInvite(user.id, globalSocket);
                    };

                    const friendRequestButton = document.createElement('button');
                    friendRequestButton.textContent = 'Send Friend Request';
                    friendRequestButton.onclick = function () {
                        sendFriendRequest(user.id);
                    };

                    userActions.appendChild(inviteButton);
                    userActions.appendChild(friendRequestButton);

                    li.appendChild(userInfo);
                    li.appendChild(userActions);
                    userList.appendChild(li);
                });
            })
            .catch(error => console.error('Error fetching connected users:', error));
        }

        document.getElementById('search-user-form').addEventListener('submit', async function (event) {
            event.preventDefault();
            const username = document.getElementById('search-username').value;
            const accessToken = sessionStorage.getItem('accessToken');
            try {
                const response = await fetch(`http://127.0.0.1:8000/api/auth/search_user/?username=${username}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                const searchResults = document.getElementById('search-results');
                searchResults.innerHTML = '';
                if (data.id) {
                    searchResults.innerHTML = `<p>${data.username} (ID: ${data.id})</p>`;
                } else {
                    searchResults.innerHTML = `<p>${data.error}</p>`;
                }
            } catch (error) {
                console.error('Error searching user:', error);
                alert('Search failed. Please try again.');
            }
        });

        document.getElementById('search-username').addEventListener('input', async function () {
            const username = document.getElementById('search-username').value;
            const accessToken = sessionStorage.getItem('accessToken');
            if (username.length < 1) { // Require at least 1 character
                document.getElementById('search-results').innerHTML = '';
                return;
            }
            try {
                const response = await fetch(`http://127.0.0.1:8000/api/auth/search_user/?username=${username}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                const searchResults = document.getElementById('search-results');
                searchResults.innerHTML = '';
                if (data.users && data.users.length > 0) {
                    searchResults.innerHTML = '<ul>' + data.users.map(user => `
                        <li>
                            ${user.username} (ID: ${user.id})
                            <button onclick="sendFriendRequest(${user.id})">Send Friend Request</button>
                        </li>`).join('') + '</ul>';
                } else if (data.error) {
                    searchResults.innerHTML = `<p>${data.error}</p>`;
                } else {
                    searchResults.innerHTML = '<p>No users found</p>';
                }
            } catch (error) {
                console.error('Error searching user:', error);
                alert('Search failed. Please try again.');
            }
        });

    </script>
</body>
</html>
