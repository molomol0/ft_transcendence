<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Game with Three.js</title>
    <style>
        body {
            margin: 0;
        }
        
        canvas {
            display: block;
        }
        #scoreboard {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            font-family: Arial, sans-serif;
        }
        </style>
</head>

<body>
    <div id="scoreboard">
        <span id="score-left">0</span> - <span id="score-right">0</span>
    </div>
    <button id="start-game-button">Start Game</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        const paddleWidth = 1, paddleHeight = 5;
        const geometry = new THREE.BoxGeometry(paddleWidth, paddleHeight, 1);
        const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const paddle1 = new THREE.Mesh(geometry, material);
        const paddle2 = new THREE.Mesh(geometry, material);
        scene.add(paddle1);
        scene.add(paddle2);
        
        paddle1.position.x = -10;
        paddle2.position.x = 10;
        
        const ballGeometry = new THREE.SphereGeometry(0.5, 32, 32);
        const ballMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const ball = new THREE.Mesh(ballGeometry, ballMaterial);
        scene.add(ball);

        ball.position.set(0, 0, 0);
        let ballDirection = { x: 0.1, y: 0.1 };

        camera.position.z = 20;
        let playerRole = null;

        let paddle1Direction = 0;
        let paddle2Direction = 0;
        const ws = new WebSocket('ws://localhost:8000/ws/pong/key/');

        let gameStarted = false;

        let winner;

        let scoreLeft = 0;
        let scoreRight = 0;

        ws.onopen = function () {
            console.log('WebSocket connection established');
        };

        ws.onmessage = function (event) {
            const message = JSON.parse(event.data);
            console.log('Received message:', message);
            if (message.event === 'assign_role') {
                playerRole = message.data;
                console.log('Assigned role:', playerRole);
            }
            if (message.event === 'game_update') {
                ball.position.x = message.data.ball.x;
                ball.position.y = message.data.ball.y;
                paddle1.position.y = message.data.players.left.pos.y;
                paddle2.position.y = message.data.players.right.pos.y;
                if (scoreLeft !== message.data.left || scoreRight !== message.data.right) {

                    document.getElementById('score-left').textContent = '';
                    document.getElementById('score-right').textContent = '';
                    
                    scoreLeft = message.data.players.left.score;
                    scoreRight = message.data.players.right.score;
                    document.getElementById('score-left').textContent = scoreLeft;
                    document.getElementById('score-right').textContent = scoreRight;
                    }
            }
            // if (message.event === 'score_updated') {
            // }
            if (message.event === 'start_game') {
                gameStarted = true;
                console.log('Game started');
            }
            if (message.event === 'game_ended') {
                gameStarted = false;
                if (message.data.winner === playerRole) {
                    alert('You won!');
                } else {
                    alert('You lost!');
                }
                resetGame();
                console.log('Game ended');
            }
        };

        ws.onclose = function () {
            console.log('WebSocket connection closed');
        };

        document.getElementById('start-game-button').addEventListener('click', function () {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ event: 'start_game', data: null }));
                console.log('Sent start_game message to WebSocket server');
            } else {
                console.log('WebSocket connection is not open');
            }
        });

        window.addEventListener('beforeunload', function () {
            ws.close();
        });

        let keysPressed = {};

        document.addEventListener('keydown', (event) => {
            keysPressed[event.key] = true;
        });

        document.addEventListener('keyup', (event) => {
            keysPressed[event.key] = false;
        });

        function updatePaddlePosition() {
            let new_direction = 0;
            if (keysPressed['w']) {
                new_direction = "up";
            } else if (keysPressed['s']) {
                new_direction = "down";
            }
        
            if (new_direction !== 0) {
                ws.send(JSON.stringify({
                    event: 'paddle_moved',
                    data: {
                        player: playerRole,
                        direction: new_direction
                    }
                }));
            }
        }

        function resetGame() {
            ball.position.set(0, 0, 0);
            paddle1.position.y = 0;
            paddle2.position.y = 0;
            paddle1Direction = 0;
            paddle2Direction = 0;
            scoreLeft = 0;
            scoreRight = 0;
            document.getElementById('score-left').textContent = scoreLeft;
            document.getElementById('score-right').textContent = scoreRight;
        }

        function animate() {
            requestAnimationFrame(animate);

            // if (!gameStarted) {
            //     return;
            // }
            updatePaddlePosition();
            renderer.render(scene, camera);
            paddle1Direction = 0;
            paddle2Direction = 0;
        }
        animate();
    </script>
    <div id="scoreboard">
        <span id="score-left">0</span> - <span id="score-right">0</span>
    </div>
</body>

</html>