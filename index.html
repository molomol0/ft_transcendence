<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Game with Three.js</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const paddleWidth = 1, paddleHeight = 5;
        const geometry = new THREE.BoxGeometry(paddleWidth, paddleHeight, 1);
        const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const paddle1 = new THREE.Mesh(geometry, material);
        const paddle2 = new THREE.Mesh(geometry, material);
        scene.add(paddle1);
        scene.add(paddle2);

        paddle1.position.x = -10;
        paddle2.position.x = 10;

        const ballGeometry = new THREE.SphereGeometry(0.5, 32, 32);
        const ballMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const ball = new THREE.Mesh(ballGeometry, ballMaterial);
        scene.add(ball);

        ball.position.set(0, 0, 0);
        let ballDirection = { x: 0.1, y: 0.1 };

        camera.position.z = 20;
        let playerRole = null;

        let paddle1Direction = 0;
        let paddle2Direction = 0;
        const ws = new WebSocket('ws://localhost:8000/ws/pong/oui/');

        let gameStarted = false;

        ws.onopen = function () {
            console.log('WebSocket connection established');
        };

        ws.onmessage = function (event) {
            const message = JSON.parse(event.data);
            console.log('Received message:', message);
            if (message.event === 'assign_role') {
                playerRole = message.data;
                console.log('Assigned role:', playerRole);
            }
            if (message.event === 'game_update') {
                ball.position.x = message.data.ball.x;
                ball.position.y = message.data.ball.y;
                paddle1.position.y = message.data.players.left.pos.y;
                paddle2.position.y = message.data.players.right.pos.y;
            }
            // if (message.event === 'paddle_moved') {
            //     if (message.data.player === 'left' && playerRole !== 'left') {
            //         paddle1.position.y = message.data.position;
            //         paddle1Direction = message.data.direction;
            //         console.log('paddle1Direction:', paddle1Direction);
            //     } else if (message.data.player === 'right' && playerRole !== 'right') {
            //         paddle2Direction = message.data.direction;
            //         paddle2.position.y = message.data.position;
            //         console.log('paddle2Direction:', paddle2Direction);
            //     }
            // }
            if (message.event === 'game_started') {
                gameStarted = true;
                // console.log('ballDirection:', message.data.ball_direction);
                // ballDirection = message.data.ball_direction;
                console.log('Game started');
            }
            if (message.event === 'game_ended') {
                gameStarted = false;
                resetGame();
                console.log('Game ended');
            }
        };

        ws.onclose = function () {
            console.log('WebSocket connection closed');
        };

        window.addEventListener('beforeunload', function () {
            ws.close();
        });

        document.addEventListener('keydown', (event) => {
            // if (playerRole === 'left') {
            //     if (event.key === 'w') {
            //         paddle1Direction = 1;
            //     } else if (event.key === 's') {
            //         paddle1Direction = -1;
            //     }
            // } else if (playerRole === 'right') {
            //     if (event.key === 'w') {
            //         paddle2Direction = 1;
            //     } else if (event.key === 's') {
            //         paddle2Direction = -1;
            //     }
            // }
            let new_direction = 0;

            if (event.key === 'w')
                new_direction = 0.5;
            else if (event.key === 's')
                new_direction = -0.5;
            ws.send(JSON.stringify({
                event: 'paddle_moved',
                data: {
                    player: playerRole,
                    direction: new_direction
                }
            }));
        });

        document.addEventListener('keyup', (event) => {
            if (playerRole === 'left') {
                if (event.key === 'w' || event.key === 's') {
                    paddle1Direction = 0;
                }
            } else if (playerRole === 'right') {
                if (event.key === 'w' || event.key === 's') {
                    paddle2Direction = 0;
                }
            }
        });

        function resetGame() {
            ball.position.set(0, 0, 0);
            paddle1.position.y = 0;
            paddle2.position.y = 0;
            paddle1Direction = 0;
            paddle2Direction = 0;
        }

        function animate() {
            requestAnimationFrame(animate);

            if (!gameStarted) {
                return;
            }

            // if (paddle1Direction !== 0) {
            //     paddle1.position.y += paddle1Direction * 0.1;
            //     if (playerRole === 'left') {
            //         ws.send(JSON.stringify({
            //             event: 'paddle_moved',
            //             data: {
            //                 player: 'left',
            //                 position: paddle1.position.y,
            //                 direction: paddle1Direction
            //             }
            //         }));
            //     }
            // }
            // if (paddle2Direction !== 0) {
            //     paddle2.position.y += paddle2Direction * 0.1;
            //     if (playerRole === 'right') {
            //         ws.send(JSON.stringify({
            //             event: 'paddle_moved',
            //             data: {
            //                 player: 'right',
            //                 position: paddle2.position.y,
            //                 direction: paddle2Direction
            //             }
            //         }));
            //     }
            // }

            // ball.position.x += ballDirection.x * 0.5;
            // ball.position.y += ballDirection.y * 0.5;

            // // Ball collision with walls
            // if (ball.position.y >= 10 || ball.position.y <= -10) {
            //     ballDirection.y = -ballDirection.y;
            // }

            // // Ball collision with paddles
            // if (ball.position.x <= paddle1.position.x + 0.5 && ball.position.y <= paddle1.position.y + 2.5 && ball.position.y >= paddle1.position.y - 2.5) {
            //     ballDirection.x = -ballDirection.x;
            // }
            // if (ball.position.x >= paddle2.position.x - 0.5 && ball.position.y <= paddle2.position.y + 2.5 && ball.position.y >= paddle2.position.y - 2.5) {
            //     ballDirection.x = -ballDirection.x;
            // }

            // // Reset game if ball is past a paddle
            // if (ball.position.x < paddle1.position.x - 1 || ball.position.x > paddle2.position.x + 1) {
            //     resetGame();
            // }

            renderer.render(scene, camera);
            paddle1Direction = 0;
            paddle2Direction = 0;
        }
        animate();
    </script>
</body>

</html>